version: 2.1
orbs:
  aws-s3: circleci/aws-s3@1.0.4

defaults:
  # This is a safe, basic set of configurations that jobs can default to.
  base: &base_defaults
    docker: 
      - image: circleci/node:latest #this should be set to a fixed version

dev-context: &dev-context
  context: dev
  filters:
    branches:
      only: develop

prod-context: &prod-context
  context: production
  filters:
    branches:
      only: master
  
jobs: 
  build-and-deploy-dev:
    << : *base_defaults
    steps:
      - checkout
      - run: yarn && yarn export
      - aws-s3/copy:
          from: out/
          to: "s3://prodigy-snowflake-dev"

  build-and-deploy-prod:
    << : *base_defaults
    steps:
      - checkout
      - run: yarn && yarn export
      - aws-s3/copy:
          from: out/
          to: "s3://prodigy-snowflake-production"
    
workflows:
  version: 2
  dev:
    jobs:
      - build-and-deploy-dev:
          <<: *dev-context
  prod:
    jobs:
      - build-and-deploy-prod:
          <<: *prod-context
